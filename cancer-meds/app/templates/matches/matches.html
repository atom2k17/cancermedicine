{% extends "base.html" %}
{% block content %}
<div class="form-container">
	<h3>Find Donations</h3>
	<form method="get">
		<div class="mb-3">
			<input name="q" class="form-control" placeholder="Search medicine name" value="{{ query }}">
		</div>
		<button class="btn btn-primary" type="submit" style="width: 100%;">Search</button>
	</form>
</div>

{% if donations %}
  <div class="container mt-4">
  {% for d in donations %}
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex w-100 justify-content-between align-items-start">
          <div>
            <h5 class="card-title">{{ d.name }}</h5>
            <p class="card-text text-muted">Qty: {{ d.quantity }} | Expiry: {{ d.expiry_date if d.expiry_date else 'N/A' }}</p>
          </div>
        </div>
        <p class="card-text"><small>Donor: Hidden (will be revealed after match)</small></p>

        {% if current_user.is_authenticated and current_user.role == 'requester' and requests %}
          <form method="post" action="{{ url_for('matches.request_match', donor_mid=d.id, request_mid=0) }}" onsubmit="return setRequestId(this, 'req-{{ d.id }}')">
            <div class="input-group">
              <select class="form-select" name="request_mid" id="req-{{ d.id }}" required>
                <option value="" disabled selected>Select your request</option>
                {% for r in requests %}
                  <option value="{{ r.id }}">{{ r.name }} (Qty: {{ r.quantity }})</option>
                {% endfor %}
              </select>
              <button class="btn btn-success" type="submit">Request Match</button>
            </div>
          </form>
        {% endif %}
      </div>
    </div>
  {% endfor %}
  </div>
{% else %}
  <div class="form-container text-center">
    <p>No donations found.</p>
  </div>
{% endif %}

<script>
function setRequestId(form, selectId) {
  var sel = document.getElementById(selectId);
  if (!sel.value) return false;
  form.action = form.action.replace('/0', '/' + sel.value);
  return true;
}
</script>
{% endblock %}