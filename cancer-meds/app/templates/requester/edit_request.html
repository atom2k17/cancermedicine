{% extends "base.html" %}
{% block content %}
<div class="form-container">
	<h3>Edit Request</h3>
	<form method="POST" enctype="multipart/form-data" novalidate>
		{{ form.hidden_tag() }}
		<div class="mb-3">
			{{ form.name.label }}
			{{ form.name(class="form-control", value=req.name) }}
			{% if form.name.errors %}
			<div class="alert alert-danger">{{ form.name.errors[0] }}</div>
			{% endif %}
		</div>
		<div class="mb-3">
			{{ form.quantity.label }}
			{{ form.quantity(class="form-control", value=req.quantity) }}
			{% if form.quantity.errors %}
			<div class="alert alert-danger">{{ form.quantity.errors[0] }}</div>
			{% endif %}
		</div>
		<div class="mb-3">
			{{ form.expiry_date.label }}
		{{ form.expiry_date(class="form-control", id="expiry_date", value=req.expiry_date.strftime('%Y-%m-%d') if req.expiry_date else '') }}
			{% if form.expiry_date.errors %}
			<div class="alert alert-danger">{{ form.expiry_date.errors[0] }}</div>
			{% endif %}
		</div>
		<div class="mb-3">
			<small class="form-text text-muted">You can add or replace uploaded prescriptions below.</small>
		</div>

		<!-- Existing Prescriptions Section -->
		{% if req.images %}
		<div class="mb-4">
			<h5 style="margin-bottom: 1rem; color: #2c3e50;">ðŸ“‹ Current Prescription Images ({{ req.images|length }})</h5>
			<p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">Check the boxes below to delete files when you click Update</p>
			<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
				{% for img in req.images %}
				<div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
					{% if img.filename.lower().endswith('.pdf') %}
					<div style="width: 100%; height: 120px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #666;">
						<div style="text-align: center; font-size: 2rem;">ðŸ“„</div>
					</div>
					{% else %}
					<img src="{{ url_for('static', filename=img.filename) }}" alt="prescription" style="width: 100%; height: 120px; object-fit: cover;">
					{% endif %}
					<div style="padding: 0.75rem; border-top: 1px solid #ecf0f1;">
						<label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0;">
							<input type="checkbox" name="delete_images" value="{{ img.id }}" style="cursor: pointer;">
							<span style="font-size: 0.85rem; color: #666;">Delete</span>
						</label>
					</div>
				</div>
				{% endfor %}
			</div>
		</div>
		{% endif %}

		<!-- Upload New Prescription Images -->
		<div class="mb-3">
			<label for="images">Add more prescription images (optional - max 3 total)</label>
			<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
				<p style="margin: 0.5rem 0; color: #856404; font-size: 0.9rem; font-weight: 600;">Include:</p>
				<ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: #856404; font-size: 0.9rem;">
					<li>Doctor's name</li>
					<li>Registration number</li>
					<li>Diagnosis/Medical condition</li>
					<li>Dosage & Period</li>
				</ul>
				<p style="margin: 0.5rem 0; color: #856404; font-size: 0.85rem;">You can add up to {{ 3 - req.images|length }} more file{{ 3 - req.images|length != 1 and 's' or '' }}</p>
			</div>
			<input type="file" name="prescriptions" id="prescriptions" class="form-control" accept=".pdf,image/*" multiple onchange="validateFileCount(this, {{ req.images|length }})">
			<small id="file-count" style="color: #666; margin-top: 0.5rem;"></small>
		</div>
		<div style="display: flex; gap: 0.8rem;">
			<button type="submit" class="btn btn-success" style="color: white; font-weight: 600; padding: 0.6rem 1.5rem;">Update</button>
			<a href="{{ url_for('meds.my_requests') }}" class="btn btn-outline-secondary" style="width: auto; flex: 1; font-weight: 600; color: #555; border-color: #999;">Cancel</a>
		</div>
	</form>
</div>

<script>
function validateForm() {
	var expiryInput = document.getElementById('expiry_date');
	var today = new Date();
	today.setHours(0, 0, 0, 0);
	
	if (expiryInput.value) {
		var expiryDate = new Date(expiryInput.value);
		if (expiryDate < today) {
			alert('Expiry date cannot be in the past');
			return false;
		}
	}
	return true;
}

document.addEventListener('DOMContentLoaded', function(){
	var expiryInput = document.getElementById('expiry_date');
	var today = new Date().toISOString().split('T')[0];
	expiryInput.min = today;
});

function validateFileCount(input, existingCount) {
	const maxFiles = 3;
	const allowedAdditional = maxFiles - existingCount;
	const countElement = document.getElementById('file-count');
	
	if (input.files.length > allowedAdditional) {
		countElement.textContent = `âŒ Too many files! You can only add ${allowedAdditional} more file${allowedAdditional !== 1 ? 's' : ''}. Selected: ${input.files.length}`;
		countElement.style.color = '#dc3545';
		input.value = '';
		return false;
	} else if (input.files.length > 0) {
		countElement.textContent = `âœ“ ${input.files.length} file${input.files.length !== 1 ? 's' : ''} selected`;
		countElement.style.color = '#28a745';
	} else {
		countElement.textContent = '';
	}
	return true;
}
</script>
{% endblock %}